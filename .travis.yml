language: java
jdk:
- oraclejdk8
install: true
env:
  global:
    - LOCAL_JMX=no
    # GITHUB TOKEN
    - secure: "04IzRrER3/TqqtbUb4J8HeoNzdu0LNF22faz4BXZEegTuJP8I0vj2m9py+1AV4AVskpVHOy1DpNesn6IufLfRlvygdmlFjOaulrMsHhZgz7bmYnBh7oza5eo49Lzexzla93xm/d3TLrD/IjLDpfqX85B6s/n3cGQZ21t/E2/oJKE2GmON+iKfGZ1TweKLrjFQn/Hu+N+EUbV86drytzyv3UO7dEgLE1fSHF+dj2fnewaAx9fzWbVguR0jnumib+uVFiJuB0zPWb47+garxBakXwi3Cmeoe9ptBlskKGsHlzmL50xi2Iej0uBotx2372p6L52PEYQz+O4QJn/4cx4yXuTfvlVuAxpZR995MsNFxrAZ7rOprmOMXMODLD0BKRvY5bGG3jd/ewybnWyuYmZ9dh9wJdGfeHsho6htuexx9x+EyQwa0D+rpuXQryizWMD4484KAY0RXhM13Gf9q/5yZ9AY0Nbs9OiHf7GXfSfRBBjVUPFQ8wEhpPQvApkqUOOWqq6DKOpxCk/EpQo01YzDDEAQUwoa7+sonISk0bxLf9U2+G/Q6PBBj6Hn0jQKfCoOnNzBqayMPA/nDGKo+EtEoiblRCXnQOOoJ+BMZ00SyDFlrf9Xo/AWfdzRCF47Dpes8M231/dOLt+4Q96GFlltOj169/LeSmZADpfPA8qtRY="
  matrix:
    - CASSANDRA_VERSION=2.1.16
    - CASSANDRA_VERSION=2.2.8
    - CASSANDRA_VERSION=3.0.9
    - CASSANDRA_VERSION=3.10

branches:
  only:
    - chrislbs/version

services:
  - postgresql
before_script:
  - psql -c 'create database reaper;' -U postgres
before_install:
  - sudo apt-get install libjna-java > /dev/null
  - sudo apt-get install python-support > /dev/null
  - sudo easy_install pyYaml > /dev/null
  - sudo easy_install pip > /dev/null
  - sudo pip install ccm > /dev/null

install:
  - ccm create test -v $CASSANDRA_VERSION > /dev/null
  - ccm populate -n 3 > /dev/null
  - sed -i 's/jmxremote.authenticate=true/jmxremote.authenticate=false/' /home/travis/.ccm/test/node1/conf/cassandra-env.sh
  - sed -i 's/jmxremote.authenticate=true/jmxremote.authenticate=false/' /home/travis/.ccm/test/node2/conf/cassandra-env.sh
  - sed -i 's/jmxremote.authenticate=true/jmxremote.authenticate=false/' /home/travis/.ccm/test/node3/conf/cassandra-env.sh
  - ccm start > /dev/null

#before_script:
#  - npm install -g bower
script:
  - mvn clean package
  - mvn surefire:test -Pintegration-tests
after_success:
  - 'if [ "$TRAVIS_PULL_REQUEST" = "false" -a "$TRAVIS_BRANCH" = "master" -a "$CASSANDRA_VERSION" = "2.1.16" ]; then mvn sonar:sonar -Dsonar.host.url=https://sonarqube.com -Dsonar.login=$SONAR_TOKEN -Dsonar.projectKey=tlp-cassandra-reaper -Dsonar.github.oauth=$GITHUB_TOKEN -Dsonar.github.repository=thelastpickle/cassandra-reaper; fi'
before_deploy: 
  - "mkdir cassandra-reaper-${TRAVIS_TAG}"
  - "mkdir cassandra-reaper-${TRAVIS_TAG}/target"
  - "cp -R bin cassandra-reaper-${TRAVIS_TAG}/"
  - "cp target/cassandra-reaper-*.jar cassandra-reaper-${TRAVIS_TAG}/target"
  - "cp -R resource cassandra-reaper-${TRAVIS_TAG}/"
  - "tar czf cassandra-reaper-${TRAVIS_TAG}-release.tar.gz cassandra-reaper-${TRAVIS_TAG}/"
deploy:
  provider: releases
  api_key: $GITHUB_TOKEN
  file_glob: true
  file: 
    - "cassandra-reaper-${TRAVIS_TAG}-release.tar.gz"
  skip_cleanup: true
  on:
    tags: true 
